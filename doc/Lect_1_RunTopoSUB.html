<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Johannes Brenner" />

<meta name="date" content="2016-05-04" />

<title>Lect 3: How to Run TopoSUB</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>



<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23header%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%20code%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />

</head>

<body>




<h1 class="title toc-ignore">Lect 3: How to Run TopoSUB</h1>
<h4 class="author"><em>Johannes Brenner</em></h4>
<h4 class="date"><em>2016-05-04</em></h4>



<div id="install-r-library-toposub" class="section level2">
<h2>Install R-library TopoSUB</h2>
<p>The R-library TopoSUB is a <a href="https://github.com/JBrenn/TopoSUB">GitHub repository</a> which can be installed via <a href="https://www.rstudio.com/products/rpackages/devtools/">devtools</a> in R. The following R snippet will install/load devtools and TopoSUB if neccessary.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">if(!<span class="kw">require</span>(TopoSUB))
{
  if(!<span class="kw">require</span>(<span class="st">&quot;devtools&quot;</span>))
  {
    <span class="kw">install.packages</span>(devtools)
    <span class="kw">require</span>(<span class="st">&quot;devtools&quot;</span>)
  }
  <span class="kw">install_github</span>(<span class="st">&quot;TopoSUB&quot;</span>, <span class="st">&quot;JBrenn&quot;</span>)
  <span class="kw">require</span>(<span class="st">&quot;TopoSUB&quot;</span>)
}</code></pre></div>
</div>
<div id="toposub-simulation-folder" class="section level2">
<h2>TopoSUB simulation folder</h2>
<p>A TopoSUB simulation folder exists of</p>
<ul>
<li><p>two TopoSUB configuration files, <em>locations.txt</em> and <em>setup.txt</em>,</p></li>
<li><p>the master folder, containing GEOtop input data (input maps, meteo, horizon, soil files), the GEOtop configuration file (<em>geotop.inpts</em>) and eventually a folder called <em>obs</em> with observed data,</p></li>
<li><p>the src folder contains additional TopoSUB functions, which are not included in the library. This folder is part of the TopoSUB repository on GitHub and can either be downloaded or cloned:</p></li>
</ul>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">git</span> clone https://github.com/JBrenn/TopoSUB</code></pre></div>
<p>For clarification on the folder structure a TopoSUB example simulation can be found <a href="https://cloud.scientificnet.org/index.php/s/Y6UwKt79pFZp2uR">here</a>.</p>
<p>The directory of these files/folders is the root directory, defined in the location configuration file. The folder names of all necessary input files have to be specified in the location configuration file. The parameters <em>1d folder</em> and <em>experiment number</em> will define the simulation output path. The <em>1d folder</em> can be seen as an project folder, where different simulations of a project are stored.</p>
<p>As the first intension of this extended version of TopoSUB were simulation runs for climate impact assessments with continuous input data up to 140 years, parallelisation is implemented either for your local machine (see example simulation) or a HPC cluster (e.g. Vienna Scientific Cluster - VSC). In the example simulation 256 point simulations are splited into 8 branches (Number of simulations in parallel mode in setup configuration file), where each branch exists of 32 point simulations, computes 32 cluster centroids. For the VSC a number of job files (specified by <em>Ncores</em>) can be created and run directly from R. For further info on the VSC see its <a href="https://wiki.vsc.ac.at/doku.php?id=start">wiki page</a>.</p>
</div>
<div id="run-toposub" class="section level2">
<h2>Run TopoSUB</h2>
<p>A TopoSUB simulation is started with the function TopoSUB_preprocessor. After preparing GEOtop input files (raster maps, meteorological stations, horizon files, …), the GEOtop configurationfile (geotop.inpts) and the TopoSUB configuration files (locations.txt, setup.txt), use this function to carry out landscape clustering and GEOtop point simulations, for computational intensive simulations preferable parallelized on a HPC server. See the function documentation for a short description.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">?TopoSUB_preprocessor</code></pre></div>
<p>For the example simulation we can run the R-script main_pre.R as following in a Linux terminal</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">Rscript</span> main_pre.R <span class="kw">&amp;</span> <span class="kw">&gt;</span> <span class="kw">log/sim1.log</span></code></pre></div>
<p>Let’s take a look at the commands it is processing</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># install/source TopoSUB library</span>
<span class="co"># see R block above</span>

<span class="co">#  source code of TopoSUB (download from TopoSUB GitHub repo)</span>
  <span class="kw">source</span>(<span class="st">&quot;src/toposub_src.r&quot;</span>)
  <span class="kw">source</span>(<span class="st">&quot;src/toposub_src_BrJ.r&quot;</span>)

<span class="co"># setup file</span>
  setupfile =<span class="st"> &quot;setup.txt&quot;</span>

<span class="co"># location file</span>
  locationfile =<span class="st"> &quot;locations.txt&quot;</span>

<span class="co"># topoSUB preprocessor</span>
  <span class="kw">TopoSUB_preprocessor</span>(<span class="dt">location.file =</span> locationfile, <span class="dt">setup.file =</span> setupfile,
                       <span class="dt">PredNamesList=</span><span class="kw">list</span>(<span class="dt">topo=</span><span class="kw">c</span>(<span class="st">&quot;dem&quot;</span>, <span class="st">&quot;slp&quot;</span>, <span class="st">&quot;asp&quot;</span>, <span class="st">&quot;svf&quot;</span>),
                                          <span class="dt">clas=</span><span class="kw">c</span>(<span class="st">&quot;landcover&quot;</span>, <span class="st">&quot;soil&quot;</span>)),
                       <span class="dt">uniform_class =</span> <span class="kw">c</span>(<span class="dt">landcover=</span><span class="ot">NA</span>, <span class="dt">soil=</span><span class="ot">NA</span>))</code></pre></div>
<p>First the additional TopoSUB functions are sourced, then we launch the preprocessor, with defined names for the location and setup configuration file. In <em>PredNamesList</em> we define the predictors we want to use for clustering, these are splitted in continuous (e.g. elevation - dem) and discrete (e.g. land cover types - landcover) data. If we want to simulate only a single land cover or soil type over the whole study area we can change the argument uniform_class accordingly. The number of the listed argument refers to the number defining specific classes in the soil/land cover input maps.</p>
</div>
<div id="toposub-project-folder-1d-folder" class="section level2">
<h2>TopoSUB Project folder | <em>1d folder</em></h2>
<p>As explained above TopoSUB is orgnised in project directories, which can be found in the <em>sim</em> folder. These are mainly meant to experiment with the configuration of TopoSUB itself, means that for each project the same master folder is used. If GEOtop specific parameterisations or input data is changed a new project should be started. The master folder is copyed once in the project folder, the simulations which were run within the project are written in a specific folder, called according to the <em>experiment number</em>, e.g. <em>00001</em>.</p>
</div>
<div id="toposub-simulation-folder-experiment-number" class="section level2">
<h2>TopoSUB simulation folder | <em>experiment number</em></h2>
<p>The main structure of a TopoSUB simulation folder is provided by the GEOtop configuration file <em>geotop.inpts</em>. If the simulation is run in parallel an extra folder <em>parallel</em> is containing the simulation output files. The TopoSUB preprocessor is creating two files of particular importance</p>
<ul>
<li><p>the <em>listpoint.txt file</em> is describing the characteristics for each cluster centroid. It is read as input in GEOtop defining point simulation setups.</p></li>
<li><p>the <em>landform .asc file</em> is mapping the IDs of the cluster centroids for each grid cell of the simulation domain. This map is later on used for re-maping simulation variables (see Lect 2: How to Postprocess a TopoSUB sim).</p></li>
</ul>
</div>
<div id="requirements" class="section level2">
<h2>Requirements</h2>
<ul>
<li>current installation of R (&gt;3.0.0) and RStudio Desktop (&gt;0.99)</li>
<li><a href="http://www.gdal.org/">gdal</a> and <a href="https://github.com/OSGeo/proj.4">proj4</a></li>
</ul>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
